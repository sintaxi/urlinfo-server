#!/usr/bin/env node

var urlinfo  = require("../")
var minimist = require("minimist")
var argv     = minimist(process.argv.slice(2))
var cfg      = require("../package.json")


/***
 *
 * urlinfo version
 *
 */

if (argv.version || argv.v || argv["_"][0] === "version") {
  console.log(cfg.version)
  process.exit()
}


/***
 *
 * urlinfo help
 *
 */

if (argv.help || argv.h || argv["_"].length == 0) {
  console.log()
  console.log("  urlinfo - " + cfg.version)
  console.log("  Service for storing and fetching url information.")
  console.log()
  console.log("  Commands:")
  console.log("    urlinfo server <file>               http server (stores records in database)")
  console.log("    urlinfo proxy <domain>              http server (proxies records to other urlinfo API)")
  console.log()
  console.log("  Options:")
  console.log("    -p, --port (9001)                   specify port for server")
  console.log("    -h, --help                          outputs this help message")
  console.log("    -v, --version                       outputs version")
  console.log()
  console.log("  Examples:")
  console.log("    urlinfo server store.db             starts server on port 9001. saves state in store.db")
  console.log("    urlinfo proxy example.com -p 9002   starts server on port 9002. proxies req. to example.com")
  console.log()
  process.exit()
}


/***
 *
 * urlinfo server path/to/file.db
 *
 */

if (argv["_"].length > 0 && argv["_"][0] === "server") {
  if (argv["_"][1]){
    var port = argv.port || argv.p || 9000
    urlinfo.createClient({ disk: argv["_"][1] }).server.listen(port, function(){
      console.log("urlinfo -", cfg.version)
      console.log("Records being stored on disk at:", argv["_"][1])
      console.log("Server listening on port", port, "...")
    })
  } else {
    var port = argv.port || argv.p || 9000
    urlinfo.createClient({}).server.listen(port, function(){
      console.log("urlinfo -", cfg.version)
      console.log("Records being stored in memory.")
      console.log("Server listening on port", port, "...")
    })
  }
}


/***
 *
 * urlinfo proxy localhost:9000
 *
 */

if (argv["_"].length > 0 && argv["_"][0] === "proxy") {
  if (argv["_"][1]){
    var port = argv.port || argv.p || 9000
    urlinfo.createClient({ proxy: argv["_"][1] }).server.listen(port, function(){
      console.log("urlinfo -", cfg.version)
      console.log("Proxing all calls to:", argv["_"][1])
      console.log("Server listening on port", port, "...")
    })
  } else {
    console.log("Domain to API required.")
    console.log("Example: `urlinfo proxy https://example.com`")
    process.exit()
  }
}
